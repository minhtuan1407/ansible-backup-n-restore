- name: Upload file to google drive
  blockinfile:
    path: /opt/backup-system.sh
    marker: "# Tuan upload file backup"
    insertbefore: EOF
    block: |
      rclone copy -P $BACKUP_RESTORE_PATH $RCLONE_PATH
    state: present
- name: Upload file recordings to google drive
  blockinfile:
    path: /opt/backup-system.sh
    marker: "# Tuan upload file recordings"
    insertbefore: EOF
    block: |
      nohup rclone copy -P --ignore-existing $RECORD_PATH $RCLONE_RECORDINGS_PATH > /dev/null 2>&1 &
    state: present
  when: recordings_path != ''
- name: Insert delete file by name
  blockinfile:
    path: /opt/backup-system.sh
    marker: "# Tuan delete file backup by name"
    insertbefore: EOF
    block: |
      cd $BACKUP_RESTORE_PATH && rm -rf $IP_SERVER-httpd-$NOW.tar.gz $IP_SERVER-apache2-$NOW.tar.gz $IP_SERVER-nginx-$NOW.tar.gz $IP_SERVER-mariadb-$NOW.tar.gz $IP_SERVER-postgresql-$NOW.tar.gz $IP_SERVER-db-*-$NOW.tar.gz $IP_SERVER-db-*-$NOW.sql.gz $IP_SERVER-asterisk-$NOW.tar.gz $IP_SERVER-freeswitch-$NOW.tar.gz $IP_SERVER-kamailio-$NOW.tar.gz $IP_SERVER-opensips-$NOW.tar.gz $IP_SERVER-rtpengine-$NOW.tar.gz $IP_SERVER-{{ custom_path_01 | replace('/','') }}-$NOW.tar.gz $IP_SERVER-{{ custom_path_02 | replace('/','') }}-$NOW.tar.gz $IP_SERVER-{{ custom_path_03 | replace('/','') }}-$NOW.tar.gz
    state: present
  when: delete_after == "true"
- name: Insert delete file on google drive by date
  blockinfile:
    path: /opt/backup-system.sh
    marker: "# Tuan delete file backup on google drive"
    insertbefore: EOF
    block: |
      rclone delete $RCLONE_PATH --include *.gz --min-age 365d
    state: present
- name: Add crontab to run backup at 03:00
  cron:
    name: "Run backup system at 03:00"
    minute: "00"
    hour: "03"
    job: "bash /opt/backup-system.sh"
  when: crontab_backup_3h == "true"
- name: Remove crontab to run backup at 03:00
  cron:
    name: "Run backup system at 03:00"
    state: absent
  when: crontab_backup_3h == "false"
- name: Run backup right now
  shell:
    cmd: "bash /opt/backup-system.sh"
  when: run_now == "true"
...

